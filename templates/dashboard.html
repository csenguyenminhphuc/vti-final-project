{% extends "base.html" %}

{% block title %}Qu·∫£n l√Ω Sinh vi√™n{% endblock %}

{% block extra_css %}
<style>
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: #fff;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #000;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="dashboard-header">
        <h2>Qu·∫£n l√Ω Sinh vi√™n</h2>
        <p>Ch√†o m·ª´ng {{ session.username }}! H·ªá th·ªëng qu·∫£n l√Ω th√¥ng tin sinh vi√™n.</p>
    </div>
    
    <div class="dashboard-actions">
        <button onclick="openAddModal()" class="btn btn-success">
            ‚ûï Th√™m sinh vi√™n m·ªõi
        </button>
        <button onclick="loadStudents()" class="btn btn-primary">
            üîÑ T·∫£i l·∫°i danh s√°ch
        </button>
    </div>
    
    <div class="students-table-container">
        <div id="loading" class="loading" style="display: none;">ƒêang t·∫£i...</div>
        <div id="error-message" class="error-message" style="display: none;"></div>
        
        <table id="students-table" class="students-table">
            <thead>
                <tr>
                    <th>M√£ SV</th>
                    <th>H·ªç v√† t√™n</th>
                    <th>Tu·ªïi</th>
                    <th>Ng√†nh h·ªçc</th>
                    <th>Kh√≥a h·ªçc</th>
                    <th>GPA</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="students-tbody">
                <!-- Students data will be loaded here -->
            </tbody>
        </table>
    </div>
</div>

<!-- Add/Edit Student Modal -->
<div id="studentModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h3 id="modal-title">Th√™m sinh vi√™n m·ªõi</h3>
        
        <form id="student-form">
            <input type="hidden" id="student-db-id">
            
            <div class="form-group">
                <label for="student_id">M√£ sinh vi√™n:</label>
                <input type="text" id="student_id" name="student_id" required class="form-control">
            </div>
            
            <div class="form-group">
                <label for="full_name">H·ªç v√† t√™n:</label>
                <input type="text" id="full_name" name="full_name" required class="form-control">
            </div>
            
            <div class="form-group">
                <label for="age">Tu·ªïi:</label>
                <input type="number" id="age" name="age" min="16" max="50" required class="form-control">
            </div>
            
            <div class="form-group">
                <label for="major">Ng√†nh h·ªçc:</label>
                <select id="major" name="major" required class="form-control">
                    <option value="">Ch·ªçn ng√†nh h·ªçc</option>
                    <option value="Khoa h·ªçc M√°y t√≠nh">Khoa h·ªçc M√°y t√≠nh</option>
                    <option value="C√¥ng ngh·ªá Th√¥ng tin">C√¥ng ngh·ªá Th√¥ng tin</option>
                    <option value="An to√†n Th√¥ng tin">An to√†n Th√¥ng tin</option>
                    <option value="Tr√≠ tu·ªá Nh√¢n t·∫°o">Tr√≠ tu·ªá Nh√¢n t·∫°o</option>
                    <option value="K·ªπ thu·∫≠t Ph·∫ßn m·ªÅm">K·ªπ thu·∫≠t Ph·∫ßn m·ªÅm</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="course">Kh√≥a h·ªçc:</label>
                <select id="course" name="course" required class="form-control">
                    <option value="">Ch·ªçn kh√≥a h·ªçc</option>
                    <option value="K2019">K2019</option>
                    <option value="K2020">K2020</option>
                    <option value="K2021">K2021</option>
                    <option value="K2022">K2022</option>
                    <option value="K2023">K2023</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="gpa">GPA:</label>
                <input type="number" id="gpa" name="gpa" min="0" max="4" step="0.01" required class="form-control">
            </div>
            
            <div class="form-actions">
                <button type="submit" class="btn btn-primary">L∆∞u</button>
                <button type="button" onclick="closeModal()" class="btn btn-secondary">H·ªßy</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let students = [];

// Load students when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadStudents();
});

async function loadStudents() {
    const loading = document.getElementById('loading');
    const errorMessage = document.getElementById('error-message');
    const tbody = document.getElementById('students-tbody');
    
    loading.style.display = 'block';
    errorMessage.style.display = 'none';
    
    try {
        const response = await fetch('/api/students');
        if (!response.ok) {
            throw new Error('Failed to load students');
        }
        
        students = await response.json();
        displayStudents(students);
    } catch (error) {
        console.error('Error loading students:', error);
        errorMessage.textContent = 'L·ªói khi t·∫£i danh s√°ch sinh vi√™n';
        errorMessage.style.display = 'block';
    } finally {
        loading.style.display = 'none';
    }
}

function displayStudents(studentList) {
    const tbody = document.getElementById('students-tbody');
    tbody.innerHTML = '';
    
    studentList.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${student.student_id}</td>
            <td>${student.full_name}</td>
            <td>${student.age}</td>
            <td>${student.major}</td>
            <td>${student.course}</td>
            <td>${student.gpa}</td>
            <td>
                <button onclick="editStudent(${student.id})" class="btn btn-sm btn-warning">S·ª≠a</button>
                <button onclick="deleteStudent(${student.id})" class="btn btn-sm btn-danger">X√≥a</button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

function openAddModal() {
    document.getElementById('modal-title').textContent = 'Th√™m sinh vi√™n m·ªõi';
    document.getElementById('student-form').reset();
    document.getElementById('student-db-id').value = '';
    document.getElementById('studentModal').style.display = 'block';
}

function editStudent(id) {
    const student = students.find(s => s.id === id);
    if (!student) return;
    
    document.getElementById('modal-title').textContent = 'Ch·ªânh s·ª≠a sinh vi√™n';
    document.getElementById('student-db-id').value = student.id;
    document.getElementById('student_id').value = student.student_id;
    document.getElementById('full_name').value = student.full_name;
    document.getElementById('age').value = student.age;
    document.getElementById('major').value = student.major;
    document.getElementById('course').value = student.course;
    document.getElementById('gpa').value = student.gpa;
    
    document.getElementById('studentModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('studentModal').style.display = 'none';
}

async function deleteStudent(id) {
    if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a sinh vi√™n n√†y?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/students/${id}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            loadStudents();
            alert('X√≥a sinh vi√™n th√†nh c√¥ng!');
        } else {
            throw new Error('Failed to delete student');
        }
    } catch (error) {
        console.error('Error deleting student:', error);
        alert('L·ªói khi x√≥a sinh vi√™n!');
    }
}

// Handle form submission
document.getElementById('student-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const studentData = {
        student_id: formData.get('student_id'),
        full_name: formData.get('full_name'),
        age: parseInt(formData.get('age')),
        major: formData.get('major'),
        course: formData.get('course'),
        gpa: parseFloat(formData.get('gpa'))
    };
    
    const id = document.getElementById('student-db-id').value;
    const isEdit = id !== '';
    
    try {
        const url = isEdit ? `/api/students/${id}` : '/api/students';
        const method = isEdit ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(studentData)
        });
        
        if (response.ok) {
            closeModal();
            loadStudents();
            alert(isEdit ? 'C·∫≠p nh·∫≠t sinh vi√™n th√†nh c√¥ng!' : 'Th√™m sinh vi√™n th√†nh c√¥ng!');
        } else {
            const error = await response.json();
            throw new Error(error.error || 'Unknown error');
        }
    } catch (error) {
        console.error('Error saving student:', error);
        alert('L·ªói khi l∆∞u th√¥ng tin sinh vi√™n: ' + error.message);
    }
});

// Close modal when clicking outside of it
window.onclick = function(event) {
    const modal = document.getElementById('studentModal');
    if (event.target === modal) {
        closeModal();
    }
}
</script>
{% endblock %}